<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CMS Admin</title>
</head>
<body>
  <!-- Cloudinary media library -->
  <script src="https://cdn.jsdelivr.net/npm/netlify-cms-media-library-cloudinary@1/dist/cloudinary.js"></script>
  <!-- Decap core -->
  <script src="https://cdn.jsdelivr.net/npm/decap-cms@^3/dist/decap-cms.js"></script>

  <script>
    // Clear Decap CMS cache để đảm bảo load config mới
    if (typeof Storage !== "undefined") {
      localStorage.removeItem("netlify-cms-user");
      localStorage.removeItem("netlify-cms-backend");
      sessionStorage.removeItem("netlify-cms-user");
      sessionStorage.removeItem("netlify-cms-backend");
    }
    
    // Đợi Decap CMS load xong rồi mới override detectProxyServer
    document.addEventListener('DOMContentLoaded', function() {
      // Đợi thêm một chút để đảm bảo CMS đã khởi tạo
      setTimeout(function() {
        // Override detectProxyServer function để tắt auto-detect Netlify proxy
        if (window.CMS && window.CMS.backends && window.CMS.backends.github) {
          const githubBackend = window.CMS.backends.github;
          if (githubBackend && typeof githubBackend.detectProxyServer === 'function') {
            githubBackend.detectProxyServer = function() {
              return Promise.resolve(null);
            };
          }
        }
      }, 1000);
    });
    
    // Đăng ký Cloudinary media library
    if (window.cloudinaryMediaLibrary && window.CMS) {
      window.CMS.registerMediaLibrary(window.cloudinaryMediaLibrary);
    }
  </script>
</body>
</html>