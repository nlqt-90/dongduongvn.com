<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CMS Admin</title>
</head>
<body>
  <script>
    // Clear Decap CMS cache
    if (typeof Storage !== "undefined") {
      localStorage.removeItem("netlify-cms-user");
      localStorage.removeItem("netlify-cms-backend");
      sessionStorage.removeItem("netlify-cms-user");
      sessionStorage.removeItem("netlify-cms-backend");
    }
  </script>
  
  <!-- Cloudinary media library -->
  <script src="https://cdn.jsdelivr.net/npm/netlify-cms-media-library-cloudinary@1/dist/cloudinary.js"></script>
  <!-- Decap core -->
  <script src="https://cdn.jsdelivr.net/npm/decap-cms@^3/dist/decap-cms.js"></script>

  <script>
    // Patch detectProxyServer ngay sau khi script load
    // Sử dụng multiple methods để đảm bảo patch được
    (function() {
      function patchProxy() {
        try {
          // Method 1: Patch qua window.CMS
          if (window.CMS && window.CMS.backends && window.CMS.backends.github) {
            const backend = window.CMS.backends.github;
            if (backend && backend.detectProxyServer) {
              backend.detectProxyServer = function() {
                console.log('[Decap CMS] Proxy detection disabled');
                return Promise.resolve(null);
              };
              console.log('[Decap CMS] Successfully patched detectProxyServer');
              return true;
            }
          }
          
          // Method 2: Patch qua module system nếu có
          if (window.__DECAP_CMS__) {
            const cms = window.__DECAP_CMS__;
            if (cms.backends && cms.backends.github) {
              cms.backends.github.detectProxyServer = function() {
                return Promise.resolve(null);
              };
              return true;
            }
          }
        } catch (e) {
          console.error('[Decap CMS] Error patching:', e);
        }
        return false;
      }
      
      // Thử patch ngay
      if (!patchProxy()) {
        // Nếu chưa được, thử lại với interval
        let attempts = 0;
        const interval = setInterval(function() {
          attempts++;
          if (patchProxy() || attempts > 50) {
            clearInterval(interval);
          }
        }, 50);
      }
    })();
    
    // Đăng ký Cloudinary media library
    if (window.cloudinaryMediaLibrary && window.CMS) {
      window.CMS.registerMediaLibrary(window.cloudinaryMediaLibrary);
    }
  </script>
</body>
</html>