---
import { getCollection, type CollectionEntry } from "astro:content";

// Số item mỗi trang
const PAGE_SIZE = 4;


// Tính danh sách path tĩnh cho các trang /projects/page/[page]
export async function getStaticPaths() {
  const PAGE_SIZE = 4;
  const entries = await getCollection("projects");
  const totalPages = Math.ceil(entries.length / PAGE_SIZE);

  // Trang 1 đã render ở /projects/, generate từ 2 → totalPages
  return Array.from({ length: totalPages - 1 }).map((_, idx) => ({
    params: { page: String(idx + 2) },
  }));
}

import PageLayout from "@layouts/PageLayout.astro";
import { CATEGORY_LABELS } from "../../../utils/categoryLabels";
import { url } from "@utils/url";   
const { page } = Astro.params; // dynamic param as string
const currentPage = Number(page);


// Fetch all projects once
const entries = await getCollection("projects");

const allProjects = (entries as CollectionEntry<"projects">[])
  .map((entry) => ({
    slug: entry.slug,
    ...entry.data,
    year: entry.data.startDate.split("-")[0] ?? "0000",
  }))
  .sort((a, b) => b.startDate.localeCompare(a.startDate));

const totalPages = Math.ceil(allProjects.length / PAGE_SIZE);
if (currentPage < 1 || currentPage > totalPages) {
  throw new Error("Page out of range");
}
const start = (currentPage - 1) * PAGE_SIZE;
const visibleProjects = allProjects.slice(start, start + PAGE_SIZE);

// filter data for filter panel
const allCategories = [...new Set(allProjects.flatMap((p) => p.categories))];
const allYears = [...new Set(allProjects.map((p) => p.year))].sort((a, b) => Number(b) - Number(a));
---

<!-- reuse same markup as index, but inject currentPage variable to highlight pagination link -->
<PageLayout
  title={`Dự Án - Trang ${currentPage} | Đông Dương`}
  pageSubtitle="An toàn - Chất lượng - Chuyên nghiệp"
  pageTitle="Các dự án đã tham gia"
>
  <link slot="head" rel="stylesheet" href={url("/assets/css/projects.min.css")} />


  <!-- FILTER -->
  <section class="projects_filters section-nopb">
    <div class="container">
      <!-- desktop buttons -->
      <div class="filter_group" data-role="cat-buttons">
        <button type="button" class="btn filter-btn active" data-filter-category="all">Tất cả</button>
        {allCategories.map((cat) => (
          <button type="button" class="btn filter-btn" data-filter-category={cat}>{CATEGORY_LABELS[cat] ?? cat}</button>
        ))}
      </div>
      <select class="filter_select filter_select--full" id="yearSelect" aria-label="Năm">
        <option value="all">Tất cả năm</option>
        {allYears.map((yr)=> (<option value={yr}>{yr}</option>))}
      </select>
    </div>
  </section>

  <section class="projects section">
    <div class="container">
      <ul class="projects_list">
        {visibleProjects.map((project) => (
          <li class="projects_list-item" data-categories={project.categories.join(',')} data-year={project.year}>
            <div class="media"><picture><img src={url(project.thumbnail)} alt={project.title}/></picture></div>
            <div class="main">
              <h3 class="main_title"><span class="text">{project.title}</span><span class="divider divider--line"></span></h3>
              <div class="main_info">
                <span class="location"><i class="icon-location icon"></i>{project.location}</span>
                <a class="link link-arrow" href={url(`/projects/${project.slug}`)}>Chi tiết <i class="icon-arrow_right icon"></i></a>
              </div>
            </div>
          </li>
        ))}
      </ul>

      <!-- pagination dots -->
      <nav class="pagination">
        <ul class="pagination_list">
          {Array.from({ length: totalPages }).map((_, idx) => {
            const link = idx === 0 ? url('/projects/') : url(`/projects/page/${idx + 1}/`);
            return (
              <li>
                <a href={link} class={`pagination_link ${idx + 1 === currentPage ? 'current' : ''}`}>{idx + 1}</a>
              </li>
            );
          })}
        </ul>
      </nav>
    </div>
  </section>

  <script>
     // @ts-nocheck
    // filter script same as index
    document.addEventListener('DOMContentLoaded', ()=>{
      const items=[...document.querySelectorAll('.projects_list-item')];
      let currentCategory='all', currentYear='all';
      const apply=()=>{items.forEach(el=>{const cats=(el.dataset.categories||'').split(',');const year=el.dataset.year||'';const okCat=currentCategory==='all'||cats.includes(currentCategory);const okYear=currentYear==='all'||year===currentYear;el.style.display= okCat&&okYear ? '' : 'none';});};
      document.querySelectorAll('[data-filter-category]').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('[data-filter-category]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentCategory=btn.dataset.filterCategory||'all';apply();}));
      document.querySelectorAll('[data-filter-year]').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('[data-filter-year]').forEach(b=>b.classList.remove('active'));btn.classList.add('active');currentYear=btn.dataset.filterYear||'all';apply();}));
    });
  </script>
</PageLayout>

