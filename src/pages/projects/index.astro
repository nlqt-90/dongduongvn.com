---
import PageLayout from "@layouts/PageLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";
import { CATEGORY_LABELS } from "../../utils/categoryLabels";
import { url } from "@utils/url";

// Kiểu project
type ProjectEntry = CollectionEntry<"projects">;

const entries = await getCollection("projects");
const allProjects = (entries as ProjectEntry[])
  .map((entry) => ({
    slug: entry.slug,
    ...entry.data,
    year: entry.data.startDate.split("-")[0] ?? "0000",
  }))
  .sort((a, b) => b.startDate.localeCompare(a.startDate));

const PAGE_SIZE = 4;
const pageCount = Math.ceil(allProjects.length / PAGE_SIZE);
const visibleProjects = allProjects.slice(0, PAGE_SIZE);

const allCategories = [...new Set(allProjects.flatMap((p) => p.categories))];
const allYears = [...new Set(allProjects.map((p) => p.year))].sort((a, b) => Number(b) - Number(a));
---

<PageLayout
  title="Dự Án đã tham gia | Đông Dương"
  pageSubtitle="An toàn - Chất lượng - Chuyên nghiệp"
  pageTitle="Các dự án đã tham gia"
>
  <link slot="head" rel="stylesheet" href={url("/assets/css/projects.min.css")} />


  <!-- FILTER -->
  <section class="projects_filters section-nopb">
    <div class="container">
      <!-- desktop buttons -->
      <div class="filter_group" data-role="cat-buttons">
        <button type="button" class="btn filter-btn active" data-filter-category="all">Tất cả</button>
        {allCategories.map((cat) => (
          <button type="button" class="btn filter-btn" data-filter-category={cat}>{CATEGORY_LABELS[cat] ?? cat}</button>
        ))}
      </div>
      <select class="filter_select filter_select--full" id="yearSelect" aria-label="Năm">
        <option value="all">Tất cả năm</option>
        {allYears.map((yr)=> (<option value={yr}>{yr}</option>))}
      </select>
    </div>
  </section>

  <!-- PROJECT LIST -->
  <section class="projects section">
    <div class="container">
      <ul class="projects_list">
        {visibleProjects.map((project) => (
          <li class="projects_list-item" data-categories={project.categories.join(',')} data-year={project.year}>
            <div class="media">
              <picture>
                <img src={url(project.thumbnail)} alt={project.title} />
              </picture>
            </div>
            <div class="main">
              <h3 class="main_title"><span class="text">{project.title}</span><span class="divider divider--line"></span></h3>
              <div class="main_info">
                <span class="location"><i class="icon-location icon"></i>{project.location}</span>
                <a class="link link-arrow" href={url(`/projects/${project.slug}`)}>Chi tiết <i class="icon-arrow_right icon"></i></a>
              </div>
            </div>
          </li>
        ))}
      </ul>

      {pageCount>1 && (<nav class="pagination"><ul class="pagination_list">{Array.from({length:pageCount}).map((_,i)=>(<li><a href={url(i===0?'/projects/':`/projects/page/${i+1}/`)} class={`pagination_link ${i===0?'current':''}`}>{i+1}</a></li>))}</ul></nav>)}
    </div>
  </section>

  <!-- SCRIPT FILTER -->
  <script>
    // @ts-nocheck
    document.addEventListener('DOMContentLoaded',()=>{
      const items=[...document.querySelectorAll('.projects_list-item')];
      let cat='all',year='all';
      const apply=()=>{
        items.forEach(el=>{
          const cats=(el.dataset.categories||'').split(',');
          const yr=el.dataset.year||'';
          const okCat=cat==='all'||cats.includes(cat);
          const okYr=year==='all'||year===yr;
          el.style.display= okCat && okYr ? '' : 'none';
        });
      };

      // category buttons
      document.querySelectorAll('[data-filter-category]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('[data-filter-category]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          cat=btn.dataset.filterCategory||'all';
          apply();
        });
      });
      document.querySelectorAll('[data-filter-year]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('[data-filter-year]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          year=btn.dataset.filterYear||'all';
          apply();
        });
      });

      // dropdown year only
      const yearSelect=document.getElementById('yearSelect');
      yearSelect?.addEventListener('change',e=>{year=e.target.value;yearSelect.classList.toggle('is-active',year!=='all');apply();});
// set initial active
yearSelect?.classList.toggle('is-active',yearSelect.value!=='all');
    });
  </script>
</PageLayout>