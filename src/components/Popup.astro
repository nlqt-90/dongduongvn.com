---
// Props: popup is a CollectionEntry<'popups'> | null | undefined
const { popup } = Astro.props as { popup: any | null };

// Guard: thiếu popup -> không render
if (!popup) return null;

// Kiểm tra thời gian hiệu lực
const today = new Date(); today.setHours(0,0,0,0);
function parseDate(val?: string | Date): Date | null {
  if (!val) return null;
  if (val instanceof Date) {
    const d = new Date(val);
    d.setHours(0, 0, 0, 0);
    return d;
  }
  if (val.includes('/')) {
    const [dd, mm, yyyy] = val.split('/').map(Number);
    return new Date(yyyy, mm - 1, dd);
  }
  return new Date(val); // ISO fallback
}

const start: Date | null = parseDate(popup.startDate);
const end: Date | null = parseDate(popup.endDate);

if ((start && today < start) || (end && today > end)) {
  return null; // ngoài khoảng thời gian, không hiển thị
}

import { url } from "@utils/url";
---

<style>
  @import "../styles/popup.css";
</style>

<div class="popup-overlay" data-role="popup-overlay" aria-hidden="false">
  <div class="popup-box">
    <button class="popup-close" data-role="popup-close" aria-label="Close popup">×</button>
    <img src={url(popup.image)} alt={popup.title} class="popup-image" loading="lazy" />
  </div>
</div>

<script>
  // @ts-nocheck simple client script: close on click X or outside box
  document.addEventListener('DOMContentLoaded', () => {
    const overlay = document.querySelector('[data-role="popup-overlay"]');
    const closeBtn = document.querySelector('[data-role="popup-close"]');
    const box = document.querySelector('.popup-box');

    const close = () => {
      if (!overlay) return;
      overlay.style.display = 'none';
    };

    closeBtn?.addEventListener('click', close);
    overlay?.addEventListener('click', (e) => {
      if (e.target === overlay) close();
    });

    // ESC key
    document.addEventListener('keyup', (e) => {
      if (e.key === 'Escape') close();
    });
  });
</script>

